# Build and digitally sign the JAR file, then upload it to Maven
name: Build and digitally sign the JAR


on: push # TODO when we're in production, this should be `release` only, and only on the main branch

# disabled this for testing purposes, will experiment on another branch to see if the GUI is really invoked
#    branches:
#      - main

jobs:
#  build:
#    runs-on: ubuntu-latest
#
#    steps:
#      - uses: actions/checkout@v3
#      - name: Set up JDK 11
#        uses: actions/setup-java@v3
#        with:
#          java-version: '11'
#          distribution: 'temurin'
#          cache: maven
#
#      - name: Build the jars
#        run: mvn source:jar javadoc:jar package -DskipTests
#      - name: Upload files for subsequent reuse by signer
#        uses: actions/upload-artifact@v3
#        with:
#          name: compiled-jar
#          # We only care about 3 files, e.g.: CmpRaComponent-2.2.2.jar, CmpRaComponent-2.2.2-sources.jar and
#          # CmpRaComponent-2.2.2-javadoc.jar, however we upload the entire target/ directory, otherwise
#          # running `mvn jar:jar` in the next job will say `JAR will be empty - no content was marked for inclusion!`
#          # and produce an empty jar.
#          path: target

  sign:
#    needs: build
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
#      - uses: actions/download-artifact@v3
#        with:
#          name: compiled-jar
#          path: target

      - name: Process retrieved files
        # here we sign them, compute hashes and write them to files, then upload to Maven Central
        run: |
          # run it once, it will fail but that's OK - we only want it to produce the files we need to sign; and later
          # we run it again, once the signatures are in place
          mvn source:jar javadoc:jar package gpg:sign nexus-staging:deploy nexus-staging:deploy-staged -DskipTests
      - name: Upload resulting artifacts
        uses: actions/upload-artifact@v3
        with:
          name: jar-sig-hash
          path: target/CmpRaComponent*.*